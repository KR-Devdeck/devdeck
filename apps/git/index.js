import simpleGit from 'simple-git';
import inquirer from 'inquirer';
import chalk from 'chalk';
import ora from 'ora';
import fs from 'fs'; // íŒŒì¼ ìƒì„±ì„ ìœ„í•´ ì¶”ê°€

const git = simpleGit();

// ğŸ¨ ìƒíƒœë³„ ì•„ì´ì½˜
const getFileIcon = (status) => {
  if (status === '?') return 'â“'; 
  if (status === 'M') return 'ğŸ“'; 
  if (status === 'A') return 'âœ¨'; 
  if (status === 'D') return 'ğŸ—‘ '; 
  return 'ğŸ“„';
};

export const runGit = async () => {
  const isRepo = await git.checkIsRepo();
  if (!isRepo) {
    console.log(chalk.red('âŒ í˜„ì¬ í´ë”ëŠ” Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤.'));
    return;
  }
  await gitMenuLoop();
};

const gitMenuLoop = async () => {
  console.clear();
  
  const status = await git.status();
  const currentBranch = status.current;
  
  // [í•µì‹¬] node_modules ë“± ë¶ˆí•„ìš”í•œ íŒŒì¼ì€ ì¹´ìš´íŠ¸ì—ì„œë„ ì œì™¸
  const cleanFiles = status.files.filter(f => !f.path.includes('node_modules/'));
  const changedCount = cleanFiles.length;

  console.log(chalk.blue.bold('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'));
  console.log(chalk.blue.bold(`â•‘ ğŸ™ DevDeck Git Manager                   â•‘`));
  console.log(chalk.blue.bold(`â•‘ ğŸŒ¿ Branch: ${chalk.green(currentBranch.padEnd(29))} â•‘`));
  console.log(chalk.blue.bold(`â•‘ ğŸ“ Changes: ${chalk.yellow(String(changedCount).padEnd(28))} â•‘`));
  console.log(chalk.blue.bold('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'));

  const { action } = await inquirer.prompt([
    {
      type: 'list',
      name: 'action',
      message: 'ë¬´ì—‡ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      pageSize: 14,
      choices: [
        { name: `ğŸ“¦ ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§• (Add) [${changedCount}]`, value: 'add' },
        { name: 'ğŸ’¾ ì»¤ë°‹ í•˜ê¸° (Commit)', value: 'commit' },
        { name: 'ğŸŒ¿ ë¸Œëœì¹˜ ê´€ë¦¬ (Checkout)', value: 'branch' },
        { name: 'ğŸš€ í‘¸ì‹œ (Push)', value: 'push' },
        { name: 'â¬‡ï¸  í’€ (Pull)', value: 'pull' },
        { name: 'ğŸ“œ ë¡œê·¸ (Log)', value: 'log' },
        new inquirer.Separator(),
        // [New] .gitignore ìƒì„± ê¸°ëŠ¥ ì¶”ê°€
        { name: 'ğŸ™ˆ .gitignore ìë™ ìƒì„± (Ignore)', value: 'ignore' },
        { name: 'ğŸ”™ ì¢…ë£Œ', value: 'quit' }
      ]
    }
  ]);

  if (action === 'quit') {
    console.log(chalk.gray('Git Manager Closed.'));
    return;
  }

  try {
    if (action === 'add') await handleAdd(cleanFiles); // í•„í„°ë§ëœ íŒŒì¼ë§Œ ë„˜ê¹€
    else if (action === 'commit') await handleCommit(status);
    else if (action === 'branch') await handleBranch(currentBranch);
    else if (action === 'push') await handlePush(currentBranch);
    else if (action === 'pull') await handlePull(currentBranch);
    else if (action === 'log') await handleLog();
    else if (action === 'ignore') await handleIgnore(); // í•¸ë“¤ëŸ¬ ì—°ê²°
  } catch (e) {
    console.log(chalk.bgRed(' ERROR '), e.message);
    await pause();
  }

  await gitMenuLoop();
};

// ğŸ“¦ 1. Add (í•„í„°ë§ ì ìš©ë¨)
const handleAdd = async (files) => {
  if (files.length === 0) {
    console.log(chalk.gray('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. (node_modules ì œì™¸ë¨)'));
    await pause();
    return;
  }

  const choices = files.map(f => ({
    name: `${getFileIcon(f.index === '?' ? '?' : f.working_dir)} ${f.path}`,
    value: f.path,
    checked: false
  }));

  const { selectedFiles } = await inquirer.prompt([
    {
      type: 'checkbox',
      name: 'selectedFiles',
      message: 'ìŠ¤í…Œì´ì§•í•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”:',
      choices: choices,
      pageSize: 15
    }
  ]);

  if (selectedFiles.length > 0) {
    const spinner = ora('Staging...').start();
    await git.add(selectedFiles);
    spinner.succeed(chalk.green(`${selectedFiles.length}ê°œ íŒŒì¼ Staged ì™„ë£Œ!`));
  }
  await pause();
};

// ğŸ™ˆ [New] .gitignore ìƒì„±ê¸°
const handleIgnore = async () => {
  if (fs.existsSync('.gitignore')) {
    console.log(chalk.yellow('âš ï¸  ì´ë¯¸ .gitignore íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤.'));
    const { overwrite } = await inquirer.prompt([{ type: 'confirm', name: 'overwrite', message: 'ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?', default: false }]);
    if (!overwrite) return;
  }

  // Node.js í•„ìˆ˜ ì œì™¸ ëª©ë¡
  const ignoreContent = `# Logs
logs
*.log
npm-debug.log*

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# nyc test coverage
.nyc_output

# Grunt intermediate storage (http://gruntjs.com/creating-plugins#storing-task-files)
.grunt

# Bower dependency directory (https://bower.io/)
bower_components

# node-waf configuration
.lock-wscript

# Compiled binary addons (https://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules/
jspm_packages/

# TypeScript v1 declaration files
typings/

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env
.env.test

# mac os
.DS_Store
`;

  fs.writeFileSync('.gitignore', ignoreContent);
  console.log(chalk.green('âœ… .gitignore íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!'));
  console.log(chalk.gray('(ì´ì œ node_modulesê°€ Git ìƒíƒœì°½ì— ëœ¨ì§€ ì•ŠìŠµë‹ˆë‹¤.)'));
  await pause();
};

// ... (ë‚˜ë¨¸ì§€ Commit, Branch, Push, Pull, Log, Pause í•¨ìˆ˜ëŠ” ê¸°ì¡´ê³¼ ë™ì¼) ...
// ì½”ë“œ ê¸¸ì´ ì ˆì•½ì„ ìœ„í•´ ì•„ë˜ í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ ì½”ë“œë¥¼ ìœ ì§€í•˜ê±°ë‚˜ ë‹¤ì‹œ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.
// ë§Œì•½ ì „ì²´ ì½”ë“œê°€ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”! (ë¬¸ë§¥ìƒ ìœ„ handleIgnoreì™€ handleAdd ìˆ˜ì •ì´ í•µì‹¬ì…ë‹ˆë‹¤)

const handleCommit = async (status) => {
  if (status.staged.length === 0) {
    console.log(chalk.yellow('âš ï¸  Stagedëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.'));
    await pause();
    return;
  }
  const { msg } = await inquirer.prompt([{ type: 'input', name: 'msg', message: 'ë©”ì‹œì§€:' }]);
  if (msg.trim()) { await git.commit(msg); console.log(chalk.green('âœ¨ ì»¤ë°‹ ì™„ë£Œ')); }
  await pause();
};

const handleBranch = async (current) => {
  const branches = await git.branchLocal();
  const list = branches.all.filter(b => b !== current);
  const { target } = await inquirer.prompt([{
    type: 'list', name: 'target', message: 'ë¸Œëœì¹˜ ì„ íƒ:',
    choices: [...list.map(b => ({ name: `ğŸŒ¿ ${b}`, value: b })), new inquirer.Separator(), { name: 'âœ¨ ìƒˆ ë¸Œëœì¹˜', value: 'new' }, { name: 'ğŸ”™ ì·¨ì†Œ', value: 'back' }]
  }]);
  if (target === 'back') return;
  if (target === 'new') {
    const { newName } = await inquirer.prompt([{ type: 'input', name: 'newName', message: 'ìƒˆ ì´ë¦„:' }]);
    if (newName) { await git.checkoutLocalBranch(newName); console.log(chalk.green(`âœ¨ ì´ë™: ${newName}`)); }
  } else {
    await git.checkout(target); console.log(chalk.green(`ğŸŒ¿ ì´ë™: ${target}`));
  }
  await pause();
};

const handlePush = async (branch) => {
  const spinner = ora('Pushing...').start();
  try { await git.push('origin', branch); spinner.succeed('ğŸš€ ì™„ë£Œ'); } catch(e) { spinner.fail('ì‹¤íŒ¨'); console.log(e.message); }
  await pause();
};

const handlePull = async (branch) => {
  const spinner = ora('Pulling...').start();
  try { await git.pull('origin', branch); spinner.succeed('â¬‡ï¸ ì™„ë£Œ'); } catch(e) { spinner.fail('ì‹¤íŒ¨'); }
  await pause();
};

const handleLog = async () => {
  const log = await git.log({ maxCount: 5 });
  console.log(chalk.yellow('\nğŸ“œ Log'));
  log.all.forEach(l => console.log(`${chalk.cyan(l.hash.slice(0,7))} ${l.message}`));
  await pause();
};

const pause = async () => {
  await inquirer.prompt([{ type: 'input', name: 'enter', message: 'ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ë©”ë‰´ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤...', prefix: '' }]);
};